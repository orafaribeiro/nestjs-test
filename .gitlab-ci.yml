stages:
  - test
  - deploy

aws-login:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  script:
    - aws eks list-clusters

updating-env-file:
  stage: test
  image: docker:latest
  variables:
    DOCKER_REGISTRY: 471112647960.dkr.ecr.us-east-2.amazonaws.com/my-api1
    IMAGE_TAG: 0.0.10
  before_script:
    - echo "DATABASE_URL=\"mysql://admin:Admin123456@database-api.cjyuskquoc67.us-east-2.rds.amazonaws.com:3306/nestjs_api"\" >> ./app/.env
    - cat ./app/.env
    - apk add --no-cache curl jq python3 py3-pip
    - pip install awscli
    - aws ecr get-login-password | docker login --username AWS --password-stdin $DOCKER_REGISTRY
    - aws --version
    - docker info
    - docker --version
  script:
    # - aws eks list-clusters
    # - aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin $DOCKER_REGISTRY
    - docker build -t $DOCKER_REGISTRY:$IMAGE_TAG -f ./app/Dockerfile "app"
    - docker push $DOCKER_REGISTRY:$IMAGE_TAG

# veryfing-env-file:
#   stage: test
#   script:
#     - cat ./app/.env

# listing-dir:
#   image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
#   script:
#     - aws eks list-clusters

# veryfing-env-file:
#   script:
#     - cat ./app/.env

deploy-prod:
  stage: deploy
  script:
    - echo "This job deploys something from the $CI_COMMIT_BRANCH branch."
  environment: production
